---
output:
  word_document:
    toc: yes
    reference_docx: Meta_Data/template.docx
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding,
  output_dir = "Output_Documents") })
---

```{r Global options set, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
source("global.R")
```

```{r}
Annual_Temp <- Temp_Anom_Table %>%
  dplyr::group_by(SurveyYear, Mean_ONI_Anom) %>%
  dplyr::summarise(Annual_Anom_All = mean(Mean_KFM_Anom))

ggplot(data = Annual_Temp,
           aes(x = Mean_ONI_Anom, y = Annual_Anom_All, color = SurveyYear)) +
      geom_smooth(method = "lm",formula = 'y ~ x') +
      geom_point()

```

## Sha Ind

```{r Shannon Index Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Diversity_Plot(Sci_Name = "shannon_2005")
```

```{r Shannon Index original 16 sites, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}
Diversity_16_Plot(Sci_Name = "shannon_all") 
```
## Sim Ind

```{r Simpsons Index Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Diversity_Plot(Sci_Name = "simpson_2005")
```

```{r Simpsons Index original 16 sites, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}
Diversity_16_Plot(Sci_Name = "simpson_all") 
```

## Com Sim

```{r Community Similarity, warning= FALSE, message= FALSE, fig.height=7.5, fig.width=10}
ggplot2::ggplot() +
  ggplot2::geom_path(data = ellipses, size = 1.25,
            aes(x = NMDS1, y = NMDS2, color = IslandName)) +
  ggplot2::geom_point(data = nMDS, size = 1.25,
             aes(x = NMDS1, y = NMDS2, shape = ReserveStatus, color = IslandName)) +
  ggplot2::geom_text(data = nMDS, size = 2, vjust = 1.5, hjust = 1,
            aes(x = NMDS1, y = NMDS2, label = SiteCode)) +
  ggplot2::geom_text(
    data = anosim_table, size = 3, vjust = -1, hjust = 1.1,
    aes(x = -Inf, y = -Inf, 
        label = paste("P-Value:", P_val, "  R:", round(R_statistic, 2), sep = ""))) +
  ggplot2::guides(shape = guide_legend(order = 1)) +
  ggplot2::scale_color_viridis_d(end = 0.9) +
  ggplot2::coord_fixed() +
  ggplot2::scale_x_reverse() +
  ggplot2::facet_wrap(facets = vars(SurveyYear), nrow = 3) +
  ggplot2::labs(color = "Island",
       shape = "Reserve Status") +
  nMDS_theme()
```

## Ran For

```{r RF Variable Importance, message=FALSE, warning=FALSE, fig.height=7.5, fig.width=10}

Top_30_MDA <- RF_Importance %>%
  dplyr::arrange(desc(MeanDecreaseAccuracy)) %>%  
  head(30) %>% 
  droplevels()

Top_30_MDG <- RF_Importance %>% 
  dplyr::arrange(desc(MeanDecreaseGini)) %>%  
  head(30) %>% 
  droplevels()

Accuracy <- ggplot2::ggplot(Top_30_MDA, aes(x = MeanDecreaseAccuracy, 
                               y = reorder(CommonName, MeanDecreaseAccuracy), 
                               color = Targeted)) +
  ggplot2::geom_point() +
  ggplot2::geom_segment(size = 1.25, 
               aes(x = min(MeanDecreaseAccuracy) -2, xend = MeanDecreaseAccuracy,
                   y = CommonName, yend = CommonName)) +
  ggplot2::labs(x = "Mean Decrease in % Accuracy", y = NULL, 
       color = NULL, linetype = NULL) +
  ggplot2::scale_x_continuous(expand = expansion(mult = c(0,.1)), 
                     limits = c(min(Top_30_MDA$MeanDecreaseAccuracy) - 2, NA)) +
  ggplot2::scale_color_manual(values = Target_Colors) +
  ggplot2::theme_classic() +
  ggplot2::theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12))

Gini <- ggplot2::ggplot(Top_30_MDG, aes(x = MeanDecreaseGini, 
                           y = reorder(CommonName, MeanDecreaseGini),
                           color = Targeted)) +
  ggplot2::geom_point() +
  ggplot2::geom_segment(size = 1.25,
               aes(x = min(MeanDecreaseGini) - 1, xend = MeanDecreaseGini,
                   y = CommonName, yend = CommonName)) +
  ggplot2::labs(x = "Mean Decrease in Gini Index", y = NULL, 
       color = NULL, linetype = NULL) +
  ggplot2::scale_x_continuous(expand = expansion(mult = c(0,.1)), 
                     limits = c(min(Top_30_MDG$MeanDecreaseGini) - 1, NA)) +
  ggplot2::scale_color_manual(values = Target_Colors) +
  ggplot2::theme_classic() +
  ggplot2::theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12))
ggpubr::ggarrange(Accuracy, Gini, ncol = 2, align = "h", common.legend = TRUE, legend = "bottom")

```

```{r RF PDP Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
df_label <- partial_df |> 
  dplyr::distinct(CommonName, Rank)

p <- ggplot2::ggplot() +
  ggplot2::geom_smooth(data = partial_df,
                       method = 'loess', formula = 'y ~ x', se = FALSE, size = 1.25, 
                       aes(x = x_var, y = yhat, color = Targeted)) + 
  ggplot2::geom_label(data = df_label, label.size = 0,
                      aes(x = -Inf, y = Inf, label = Rank),
                      hjust = 0, vjust = 1, size = 4) +
  ggplot2::scale_color_manual(values = Target_Colors, limits = force) +
  # ggplot2::scale_color_viridis_d(end = 0.95) +
  ggplot2::scale_y_continuous(expand = c(0, 0.01)) +
  ggplot2::scale_x_continuous(expand = c(0, 0)) +
  ggplot2::labs(x = NULL, y = NULL, color = NULL) +
  ggplot2::theme_minimal() +
  PDP_theme()
p1 <- p +
  ggforce::facet_wrap_paginate(facets = vars(CommonName), 
                               nrow = 5, ncol = 3, page = 1, scales = "free") 
p2 <- p +
  ggforce::facet_wrap_paginate(facets = vars(CommonName), 
                               nrow = 5, ncol = 3, page = 2, scales = "free")
print(p1)
print(p2)
```

```{r RD PDP individual, warning=FALSE, message=FALSE}
# Choose any variable to plot PDP
Imp_Num <- 36
pdp::partial(RF_Reserve_Model_2005,
                    pred.var = RF_Importance$Common_Name[Imp_Num],
                    train = Mixed_2005, plot = TRUE, rug = TRUE,
                    plot.engine = "ggplot2") +
    ggplot2::labs(title = gsub("_", " ", RF_Importance$Common_Name[Imp_Num]),
         x = RF_Importance$Data_Type[Imp_Num], y = NULL, color = NULL) +
    theme_classic() +
    theme(plot.title = element_text(hjust = .5, size = 10),
          axis.title = element_text(size = 9))
```

## Ind Spe Ana

```{r ISA with New Density DF, fig.width=10, fig.height=7.5}
Density_Wide <- Density |> 
  dplyr::filter(!Survey_Type %in% c("VFT", "RPC"), 
                !ScientificName %in% c(
                  "Alloclinus holderi", "Coryphopterus nicholsi", "Lythrypnus dalli") | 
                  Survey_Type == "1 m² quads") |> 
  dplyr::select(SiteNumber, IslandCode, IslandName, SiteCode, SiteName, SurveyYear, 
                ReserveStatus, CommonName, Count) |> 
  tidyr::pivot_wider(names_from = "CommonName", values_from = "Count", values_fill = 0) |> 
  dplyr::rename_with(~ base::gsub(",", "", .)) |> 
  dplyr::rename_with(~ base::gsub(" ", "_", .)) |> 
  dplyr::rename_with(~ base::gsub("-", "_", .)) |> 
  dplyr::rename_with(~ base::gsub("'", "", .)) |> 
  dplyr::rename_with(~ base::gsub("<", "", .)) |> 
  dplyr::rename_with(~ base::gsub(">", "", .)) |> 
  dplyr::rename_with(~ base::gsub("1", "", .)) |> 
  dplyr::rename_with(~ base::gsub("0", "", .)) |> 
  dplyr::rename_with(~ base::gsub("5", "", .)) |> 
  dplyr::rename_with(~ base::gsub("[()]", "", .)) |> 
  dplyr::rename(giant_kelp_subadult = giant_kelp_subadult_m_and_no_haptera_above_the_primary_dichotomy,
                giant_kelp_adult = giant_kelp_adult_m_and_haptera_above_the_primary_dichotomy,
                Sargassum_horneri_adult = Sargassum_horneri_adult_cm_or_recepticles_present,
                Sargassum_horneri_juvenile = Sargassum_horneri_juvenile_cm_and_no_recepticles) %>% 
  dplyr::select(1:7, sort(names(.)))

indic_spp_table <- dplyr::data_frame(
  ScientificName = character(), s.SR = double(), s.SC = double(), 
  s.AN = double(), s.SB = double(), index = integer(), stat = double(),
  p.value = double(), Year = integer(), ReserveStatus = character())

for (h in base::unique(Density_Wide$ReserveStatus)) {
  for (k in base::unique(Density_Wide$SurveyYear)) {
    Indic_Spp <- Density_Wide %>%
      dplyr::filter(ReserveStatus %in% h,
                    SurveyYear %in% k) %>%
      dplyr::select(-SiteNumber, -IslandCode, -IslandName, 
                    -SiteCode, -SiteName, -SurveyYear, -ReserveStatus) %>%
      indicspecies::multipatt(multipatt_island_list, func = "r.g", control = how(nperm = 1000)) %>% 
      base::getElement('sign') %>%
      tibble::rownames_to_column("ScientificName") %>%
      dplyr::mutate(Year = k, ReserveStatus = h) %>%
      dplyr::filter(p.value < 0.05) 
    indic_spp_table <- base::rbind(indic_spp_table, Indic_Spp)
  }
}

indic_sites <- c("s.SR", "s.SC", "s.AN", "s.SB")

for (h in base::unique(Density_Wide$ReserveStatus)) {
  for (i in indic_sites) {
    Spp_List <- indic_spp_table %>%
      dplyr::filter(!!as.symbol(i) == 1, ReserveStatus %in% h) %>%
      base::getElement('ScientificName') %>%
      base::unique() 
    
    unique_spplist <- base::paste(h, i, "_Spp_List", sep = "")
    base::assign(unique_spplist, Spp_List)
  }
}

heat_map_data <- base::data.frame(
  ScientificName = character(), stat = double(), p.value = double(),
  year = integer(), IslandName = character(), ReserveStatus = character())

for (h in base::unique(Density_Wide$ReserveStatus)) {
  for (z in indic_sites) {
    Spp_Scores <- indic_spp_table %>%
      dplyr::filter(!!as.symbol(z) == 1, ReserveStatus %in% h) %>%
      dplyr::mutate(IslandName = z, ReserveStatus = h)
    heat_map_data <- heat_map_data %>%
      base::rbind(Spp_Scores)
  }
}

heat_map_data <- dplyr::select(
  heat_map_data, ScientificName, stat, p.value, Year, IslandName, ReserveStatus)

Outside_Heat_Species <- 
  base::rep(c(Outsides.SR_Spp_List, Outsides.SC_Spp_List,
              Outsides.AN_Spp_List, Outsides.SB_Spp_List), 
            times = base::length(unique(heat_map_data$Year)))
Inside_Heat_Species <- 
  base::rep(c(Insides.SR_Spp_List, Insides.SC_Spp_List, 
              Insides.AN_Spp_List, Insides.SB_Spp_List), 
            times = base::length(unique(heat_map_data$Year)))
Outside_Heat_Sites <- 
  base::rep(c((base::rep("s.SR", each = length(Outsides.SR_Spp_List))), 
              (base::rep("s.SC", each = base::length(Outsides.SC_Spp_List))), 
              (base::rep("s.AN", each = base::length(Outsides.AN_Spp_List))), 
              (base::rep("s.SB", each = base::length(Outsides.SB_Spp_List)))),
            times = base::length(base::unique(heat_map_data$Year)))
Inside_Heat_Sites <- 
  base::rep(c((base::rep("s.SR", each = length(Insides.SR_Spp_List))), 
              (base::rep("s.SC", each = base::length(Insides.SC_Spp_List))), 
              (base::rep("s.AN", each = base::length(Insides.AN_Spp_List))), 
              (base::rep("s.SB", each = base::length(Insides.SB_Spp_List)))),
            times = base::length(base::unique(heat_map_data$Year)))
Outside_Heat_Year <- 
  base::rep((base::unique(heat_map_data$Year)), each = 
              ((base::length(Outsides.SR_Spp_List))+
                 (base::length(Outsides.SC_Spp_List))+
                 (base::length(Outsides.AN_Spp_List))+
                 (base::length(Outsides.SB_Spp_List))))
Inside_Heat_Year <- 
  base::rep((base::unique(heat_map_data$Year)), each = 
              ((base::length(Insides.SR_Spp_List))+
                 (base::length(Insides.SC_Spp_List))+
                 (base::length(Insides.AN_Spp_List))+
                 (base::length(Insides.SB_Spp_List))))
Outside_full_heat_table <-  base::data.frame(
  IslandName = Outside_Heat_Sites, Year = Outside_Heat_Year, 
  ScientificName = Outside_Heat_Species, ReserveStatus = "Outside")

Inside_full_heat_table <-  base::data.frame(
  IslandName = Inside_Heat_Sites, Year = Inside_Heat_Year, 
  ScientificName = Inside_Heat_Species, ReserveStatus = "Inside")

full_heat_table <- rbind(Outside_full_heat_table, Inside_full_heat_table)

# short_names <- Species_Info %>% 
#   dplyr::select(ScientificName, ScientificName_Short_Form, Classification, Class_Short) %>% 
#   dplyr::filter(ScientificName %in% unique(indic_spp_table$ScientificName)) %>% 
#   dplyr::distinct()

heat_map <- dplyr::left_join(
  full_heat_table, heat_map_data, by=c(
    "IslandName", "Year", "ScientificName", "ReserveStatus")) %>%
  dplyr::mutate(IslandName = dplyr::recode_factor(
    IslandName, s.SR ="Santa Rosa Island", s.SC ="Santa Cruz Island",
    s.AN ="Anacapa Island", s.SB ="Santa Barbara Island")) %>% 
  dplyr::group_by(IslandName, ScientificName, ReserveStatus) %>% 
  dplyr::mutate(frequency = length(stat[!is.na(stat)])) %>% 
  dplyr::ungroup() %>% 
  # dplyr::left_join(short_names) %>%
  dplyr::arrange(# desc(Class_Short), 
                 desc(frequency), desc(ReserveStatus)) 

z <- 1
for(i in levels(heat_map$IslandName)) {
  Island_Heat_Data <- heat_map %>% 
    dplyr::filter(IslandName == i) 
  
  # Island_Heat_Data$ScientificName_Short_Form = fct_rev(
  #   factor(Island_Heat_Data$ScientificName_Short_Form, 
  #          levels = unique(Island_Heat_Data$ScientificName_Short_Form)))
  
  # Island_Heat_Data$Classification = factor(
  #   Island_Heat_Data$Classification, levels = c("Fish", "Invertebrates", "Algae"))
  
  p <- ggplot2::ggplot() +
    geom_tile(data = Island_Heat_Data,
              aes(x = Year, y = ScientificName, fill = stat), color = "black") +
    ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by, expand = c(0, 0)) +
    ggplot2::scale_y_discrete(expand = c(0, 0)) +
    ggplot2::scale_fill_gradient2(low = scales::muted("lightgreen"), 
                                  high = "forestgreen", na.value = scales::muted("firebrick")) + 
    ggplot2::facet_grid(#rows = vars(Classification), 
                        cols = vars(ReserveStatus), scales = "free", space = "free") +
    ggplot2::labs(title = i, x = "Year", y = "Species/Taxa", 
                  fill = paste("Strength of", "\n", "Association")) +
    ISA_theme()
  unique_plotname <- paste("ISA.", z, sep = "")
  assign(unique_plotname, p)
  z <- z + 1
}
ISA.1
ISA.2
ISA.3
ISA.4
```

## Par Par

```{r Parastichopus parvimensis Density Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Mean_Density_Plot(Sci_Name = "Parastichopus parvimensis")
```

```{r Parastichopus parvimensis original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Mean_Density_16_Plot(Sci_Name = "Parastichopus parvimensis",  
                     Com_Name = "warty sea cucumber") 
```

## Kel Kel

```{r Kelletia kelletii Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Mean_Biomass_Plot(Sci_Name = "Kelletia kelletii", Com_Name = "Kellet's whelk")
```

```{r Kelletia kelletii original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Mean_Biomass_16_Plot(Sci_Name = "Kelletia kelletii")
```

## Pan Int

```{r Panulirus interruptus Density Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Mean_Density_Plot(Sci_Name = "Panulirus interruptus")
```

```{r Panulirus interruptus original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Mean_Density_16_Plot(Sci_Name = "Panulirus interruptus", 
                     Com_Name = "California spiny lobster") 
```

## Hyp Rub

```{r Hypsypops rubicundus Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Mean_Biomass_Plot(Sci_Name = "Hypsypops rubicundus", Com_Name = "garibaldi")
```

```{r Hypsypops rubicundus original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Mean_Density_16_Plot(Sci_Name = "Hypsypops rubicundus",  
                     Com_Name = c("garibaldi, adult", "garibaldi, juvenile"))
```

## Cys Osm

```{r Cystoseira cover Plots, fig.width=7.5, warning=FALSE, message=FALSE, fig.height=8.5}
Percent_Cover_Plot(Sci_Name = "Cystoseira")
```

```{r Cystoseira original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Percent_Cover_Original_16_Plot(Sci_Name = "Cystoseira")
```

## Tet Aur

```{r Tethya aurantia Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Mean_Biomass_Plot(Sci_Name = "Tethya aurantia", Com_Name = "orange puffball sponge")
```

```{r Tethya aurantia original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Mean_Biomass_16_Plot(Sci_Name = "Tethya aurantia")
```

## Str Fra

```{r Strongylocentrotus franciscanus Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Mean_Biomass_Plot(Sci_Name = "Strongylocentrotus franciscanus", Com_Name = "red sea urchin")
```

```{r Strongylocentrotus franciscanus original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Mean_Biomass_16_Plot(Sci_Name = "Strongylocentrotus franciscanus")
```

## Pat Min

```{r Patiria miniata Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Mean_Biomass_Plot(Sci_Name = "Patiria miniata", Com_Name = "bat star")
```

```{r Patiria miniata original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Mean_Biomass_16_Plot(Sci_Name = "Patiria miniata")
```

## Mac Pyr

```{r Macrocystis pyrifera Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Mean_Biomass_Plot(Sci_Name = "Macrocystis pyrifera", Com_Name = "giant kelp, adult (>1m)")
```

```{r Macrocystis pyrifera original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Mean_Biomass_16_Plot(Sci_Name = "Macrocystis pyrifera")
```

## Sem Pul

```{r Semicossyphus pulcher male Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Mean_Biomass_Plot(Sci_Name = "Semicossyphus pulcher", Com_Name = "California sheephead, male")
```

```{r Semicossyphus pulcher male original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Mean_Density_16_Plot(Sci_Name = "Semicossyphus pulcher", 
                     Com_Name = "California sheephead, male")
```

## Lyt Ana

```{r Lytechinus anamesus Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Mean_Biomass_Plot(Sci_Name = "Lytechinus anamesus", Com_Name = "white sea urchin")
```

```{r Lytechinus anamesus original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Mean_Biomass_16_Plot(Sci_Name = "Lytechinus anamesus")
```

## Str Pur

```{r Strongylocentrotus purpuratus Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Mean_Biomass_Plot(Sci_Name = "Strongylocentrotus purpuratus", Com_Name = "purple sea urchin")
```

```{r Strongylocentrotus purpuratus original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Mean_Biomass_16_Plot(Sci_Name = "Strongylocentrotus purpuratus")
```

## Par Cla

```{r Paralabrax clathratus Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Mean_Biomass_Plot(Sci_Name = "Paralabrax clathratus", Com_Name = "kelp bass")
```

```{r Paralabrax clathratus original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Mean_Density_16_Plot(Sci_Name = "Paralabrax clathratus", 
                     Com_Name = c("kelp bass, adult", "kelp bass, juvenile"))
```

## Pyc Hel

```{r Pycnopodia helianthoides Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}
Mean_Biomass_Plot(Sci_Name = "Pycnopodia helianthoides", Com_Name = "sunflower star")
```

```{r Pycnopodia helianthoides original 16 sites, warning=FALSE, message=FALSE, fig.height=5, fig.width=9}
Mean_Biomass_16_Plot(Sci_Name = "Pycnopodia helianthoides")
```

ADD MORE SPECIES?

## Bio Sum

```{r Benthic Biomass Summary, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=11}
Ben_Bio <- Biomass |> 
  dplyr::filter(Classification %in% c("Algae","Invertebrates"),
                CommonName %in% c("Targeted", "Non-targeted")) 

ggplot2::ggplot(Ben_Bio, aes(x = SurveyYear, y = Mean_Biomass, fill = CommonName)) +
  ggplot2::geom_area(position = "stack", stat = "smooth") +
  ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by, expand = c(0, 0.09)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(0, .05))) +
  ggplot2::facet_grid(rows= vars(IslandName), cols = vars(ReserveStatus), scales = "free") +
  ggplot2::scale_fill_viridis_d(end = .8, guide = guide_legend(ncol = 1)) +
  ggplot2::labs(title = "All Ivertebrates", x = "Survey Year",
                y = "Mean Biomass (g/m²)", fill = NULL) +
  Biomass_Summary_theme() 
```

```{r Benthic Biomass NT Summary, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=11}
Ben_Bio <- Biomass |> 
  dplyr::filter(Classification %in% c("Algae","Invertebrates"),
                Targeted_Broad == "Non-targeted",
                !CommonName %in% c(
                  "total benthic biomass",
                  "Targeted", "Non-targeted",
                  "Herbivore", "Planktivore", "Carnivore"))

ggplot2::ggplot(Ben_Bio, aes(x = SurveyYear, y = Mean_Biomass, fill = CommonName)) +
  ggplot2::geom_area(position = "stack", stat = "smooth") +
  ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by, expand = c(0, 0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(0, .05))) +
  ggplot2::scale_fill_viridis_d(guide = guide_legend(ncol = 1)) +
  ggplot2::facet_grid(rows= vars(IslandName), cols = vars(ReserveStatus), scales = "free") +
  ggplot2::labs(title = "Non-targeted Invertebrates", x = "Survey Year", 
                y = "Mean Biomass (g/m²)", fill = NULL) +
  Biomass_Summary_theme()
```

```{r Benthic Biomass T Summary, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=11}
Ben_Bio <- Biomass |> 
  dplyr::filter(Classification %in% c("Algae","Invertebrates"),
                Targeted_Broad == "Targeted",
                !CommonName %in% c(
                  "total benthic biomass",
                  "Targeted", "Non-targeted",
                  "Herbivore", "Planktivore", "Carnivore"))

ggplot2::ggplot(Ben_Bio, aes(x = SurveyYear, y = Mean_Biomass, fill = CommonName)) +
  ggplot2::geom_area(position = "stack", stat = "smooth") + 
  ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by, expand = c(0, 0)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(0, .05))) +
  ggplot2::scale_fill_viridis_d(guide = guide_legend(ncol = 1)) +
  ggplot2::facet_grid(rows= vars(IslandName), cols = vars(ReserveStatus), scales = "free") +
  ggplot2::labs(title = "Targeted Invertebrates", x = "Survey Year", y = "Mean Biomass (g/m²)", 
                fill = NULL) +
  Biomass_Summary_theme()
```

```{r Fish All, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=11}
Fish_Bio <- Biomass |> 
  dplyr::filter(Classification %in% c("Fish"),
                CommonName %in% c("Targeted", "Non-targeted"))

ggplot2::ggplot(data = Fish_Bio, aes(x = SurveyYear, y = Mean_Biomass/2000, fill = CommonName)) +
  ggplot2::geom_area(position = "stack", stat = "smooth") + 
  ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by, expand = c(0, 0.01)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(0, .05))) +
  ggplot2::scale_fill_viridis_d(guide = guide_legend(ncol = 1), end = .8) +
  ggplot2::facet_grid(rows= vars(IslandName), cols = vars(ReserveStatus), scales = "free") +
  ggplot2::labs(title = NULL, subtitle = "All Fish",
                x = "Survey Year", y = "Mean Biomass (g/m²)", fill = NULL) +
  Biomass_Summary_theme()
```

```{r Fish Targeted, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=11}
Fish_Bio <- Biomass |> 
  dplyr::filter(Classification %in% c("Fish"),
                Targeted_Broad == "Targeted", 
                !CommonName %in% c(
                  "total fish biomass",
                  "Targeted", "Non-targeted",
                  "Herbivore", "Planktivore", "Carnivore", "Piscovore"))

ggplot2::ggplot(data = Fish_Bio, aes(x = SurveyYear, y = Mean_Biomass/2000, fill = CommonName)) +
  ggplot2::geom_area(position = "stack", stat = "smooth") + 
  ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by, expand = c(0, 0.01)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(0, .05))) +
  ggplot2::scale_fill_viridis_d(guide = guide_legend(ncol = 1)) +
  ggplot2::facet_grid(rows= vars(IslandName), cols = vars(ReserveStatus), scales = "free") +
  ggplot2::labs(title = NULL, subtitle = "Targeted Fish",
                x = "Survey Year", y = "Mean Biomass (g/m²)", fill = NULL) +
  Biomass_Summary_theme()
```

```{r Fish Non-targeted, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=11}
Fish_Bio <- Biomass |> 
  dplyr::filter(Classification %in% c("Fish"),
                Targeted_Broad == "Non-targeted", 
                !CommonName %in% c(
                  "total fish biomass",
                  "Targeted", "Non-targeted",
                  "Herbivore", "Planktivore", "Carnivore", "Piscovore"))

ggplot2::ggplot(data = Fish_Bio, aes(x = SurveyYear, y = Mean_Biomass/2000, fill = CommonName)) +
  ggplot2::geom_area(position = "stack", stat = "smooth") + 
  ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by, expand = c(0, 0.01)) +
  ggplot2::scale_y_continuous(expand = expansion(mult = c(0, .05))) +
  ggplot2::scale_fill_viridis_d(guide = guide_legend(ncol = 1)) +
  ggplot2::facet_grid(rows= vars(IslandName), cols = vars(ReserveStatus), scales = "free") +
  ggplot2::labs(title = NULL, subtitle = "Non-targeted Fish",
                x = "Survey Year", y = "Mean Biomass (g/m²)", fill = NULL) +
  Biomass_Summary_theme()
```

## Ratio - Fish

```{r, fig.height=11, fig.width=8.5}
Fish_Ratio <- All_Ratios |> 
  dplyr::filter(Classification %in% c("Fish", "Mixed"),
                Metric == "biomass_ratio") |> 
  dplyr::mutate(Targeted_Broad = factor(Targeted_Broad, levels = c('Targeted', 'Non-targeted', 'Mixed'))) |> 
  dplyr::arrange(Targeted_Broad) |> 
  dplyr::mutate(CommonName = fct_inorder(CommonName))

p <- ggplot2::ggplot(data = Fish_Ratio, aes(x = SurveyYear, y = Mean_Ratio, color = Targeted_Broad)) +
  ggplot2::geom_hline(aes(yintercept = 1)) +
  ggplot2::geom_point(size = 3, stroke = 2, aes(shape = Targeted_Broad), fill = "blue") +
  ggplot2::geom_errorbar(aes(x = SurveyYear, width = .5,
                    ymin = Mean_Ratio - CI_minus,
                    ymax = Mean_Ratio + CI_plus)) +
  ggplot2::scale_color_manual(values = Target_Colors, limits = force) +
  ggplot2::scale_shape_manual(values = c("Targeted" = 10, "Non-targeted" = 5, "Mixed" = 6)) +
  ggplot2::labs(title = NULL, color = "Fishery Status", shape = "Fishery Status", x = NULL, y = NULL) +
  ggplot2::scale_y_continuous(trans = 'log10') +
  ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by, expand = c(0, 0)) +
  ggplot2::coord_cartesian(ylim = c(NA, max(Fish_Ratio$Mean_Ratio) * 1.2)) +
  Ratio_theme()

p1 <- p +
  ggforce::facet_wrap_paginate(
    facets = vars(CommonName), nrow = 6, ncol = 1, page = 1, scales = "free")

p2 <- p +
  ggforce::facet_wrap_paginate(
    facets = vars(CommonName), nrow = 6, ncol = 1, page = 2, scales = "free")

p3 <- p +
  ggforce::facet_wrap_paginate(
    facets = vars(CommonName), nrow = 6, ncol = 1, page = 3, scales = "free")

p4 <- p +
  ggforce::facet_wrap_paginate(
    facets = vars(CommonName), nrow = 6, ncol = 1, page = 4, scales = "free")

p5 <- p +
  ggforce::facet_wrap_paginate(
    facets = vars(CommonName), nrow = 6, ncol = 1, page = 5, scales = "free")

p1
p2
p3
p4
p5
```

## Ratio - Benthic

```{r, fig.height=11, fig.width=8.5}
Benthic_Ratio <- All_Ratios |> 
  dplyr::filter(Classification %in% c("Algae", "Invertebrates"),
                Metric == "biomass_ratio") |> 
  dplyr::mutate(Targeted_Broad = factor(Targeted_Broad, levels = c('Targeted', 'Non-targeted', 'Mixed'))) |> 
  dplyr::arrange(Targeted_Broad) |> 
  dplyr::mutate(CommonName = fct_inorder(CommonName))

p <- ggplot2::ggplot(data = Benthic_Ratio, aes(x = SurveyYear, y = Mean_Ratio, color = Targeted_Broad)) +
  ggplot2::geom_hline(aes(yintercept = 1)) +
  ggplot2::geom_point(size = 3, stroke = 2, aes(shape = Targeted_Broad), fill = "blue") +
  ggplot2::geom_errorbar(aes(x = SurveyYear, width = .5,
                    ymin = Mean_Ratio - CI_minus,
                    ymax = Mean_Ratio + CI_plus)) +
  ggplot2::scale_color_manual(values = Target_Colors, limits = force) +
  ggplot2::scale_shape_manual(values = c("Targeted" = 10, "Non-targeted" = 5, "Mixed" = 6)) +
  ggplot2::labs(title = NULL, color = "Fishery Status", shape = "Fishery Status", x = NULL, y = NULL) +
  ggplot2::scale_y_continuous(trans = 'log10') +
  ggplot2::scale_x_continuous(breaks = 2005:Year_to_Filter_Data_by, expand = c(0, 0)) +
  ggplot2::coord_cartesian(ylim = c(NA, max(Benthic_Ratio$Mean_Ratio) * 1.2)) +
  Ratio_theme()

p1 <- p +
  ggforce::facet_wrap_paginate(
    facets = vars(CommonName), nrow = 6, ncol = 1, page = 1, scales = "free")

p2 <- p +
  ggforce::facet_wrap_paginate(
    facets = vars(CommonName), nrow = 6, ncol = 1, page = 2, scales = "free")

p3 <- p +
  ggforce::facet_wrap_paginate(
    facets = vars(CommonName), nrow = 6, ncol = 1, page = 3, scales = "free")

p4 <- p +
  ggforce::facet_wrap_paginate(
    facets = vars(CommonName), nrow = 6, ncol = 1, page = 4, scales = "free")

p5 <- p +
  ggforce::facet_wrap_paginate(
    facets = vars(CommonName), nrow = 6, ncol = 1, page = 5, scales = "free")

p1
p2
p3
p4
p5
```

## Pis Gig

```{r Pisaster giganteus Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

``` 

```{r Pisaster giganteus original 16 sites, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}

```

## Cen Cor

```{r Centrostephanus coronatus Density Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

``` 

```{r Centrostephanus coronatus original 16 sites, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}

```

## Hal Ruf

```{r Haliotis rufescens Biomass Plots, warning=FALSE, message=FALSE, fig.height=8.5, fig.width=7.5}

``` 

```{r Haliotis rufescens original 16 sites, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}

```

## Tables and Equations

```{r Heat Map Summary and Cross Reference Tables}
# heat_table_summary <- heat_map %>% 
#   tidyr::drop_na() %>% 
#   dplyr::group_by(ScientificName, Year) %>%
#   dplyr::mutate(Distribution = n(),
#                 Years = "Years") %>%
#   dplyr::ungroup() %>%
#   dplyr::filter(Distribution > 1) %>%
#   dplyr::distinct(ScientificName, Year, Years) %>%
#   dplyr::select(ScientificName, Year, Years) %>%
#   dplyr::arrange(ScientificName, Year, Years)  %>%
#   tidyr::pivot_wider(names_from = Years, values_from = Year, values_fn = list)
# 
# knitr::kable(heat_table_summary)
```
